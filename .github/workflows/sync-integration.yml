name: Sync Shared Directory

on:
  push:
    branches: [ main ]
    paths:
      - 'shared/**'
      - '.github/workflows/**'
  pull_request:
    types: [closed]
    branches: [ main ]
    paths:
      - 'shared/**'
  workflow_dispatch:

jobs:
  sync-shared:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    strategy:
      matrix:
        team: [
          {
            name: 'right',
            repo: 'KDT-PWA-1-Project-A-Team-Right'
          },
          {
            name: 'left',
            repo: 'KDT-PWA-1-Project-A-Team-Left'
          }
        ]
      fail-fast: false

    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: source-repo

      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: KDT-PWA-Class-One-Group/${{ matrix.team.repo }}
          token: ${{ secrets.PAT_TOKEN }}
          path: target-repo
          ref: main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Sync shared directory
        run: |
          # shared ë””ë ‰í† ë¦¬ ì „ì²´ ë™ê¸°í™”
          rm -rf target-repo/shared
          cp -r source-repo/shared target-repo/

          # package.json ì˜ì¡´ì„± ë³‘í•©
          if [ -f "target-repo/package.json" ]; then
            node -e "
              const sourcePackage = require('./source-repo/shared/package.json');
              const targetPackage = require('./target-repo/package.json');

              // devDependencies ë³‘í•©
              targetPackage.devDependencies = {
                ...targetPackage.devDependencies,
                ...sourcePackage.devDependencies
              };

              // scripts ë³‘í•©
              targetPackage.scripts = {
                ...targetPackage.scripts,
                ...sourcePackage.scripts
              };

              // engines ì„¤ì • ì—…ë°ì´íŠ¸
              targetPackage.engines = sourcePackage.engines;

              require('fs').writeFileSync(
                './target-repo/package.json',
                JSON.stringify(targetPackage, null, 2)
              );
            "
          fi

      - name: Check for changes
        id: check-changes
        working-directory: target-repo
        run: |
          git add .
          git status --porcelain
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Configure Git
        if: steps.check-changes.outputs.changes == 'true'
        working-directory: target-repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and push changes
        if: steps.check-changes.outputs.changes == 'true'
        working-directory: target-repo
        run: |
          # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ìƒì„±
          CHANGED_FILES=$(git status --porcelain | awk '{print $2}')

          # ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„±
          COMMIT_MSG="chore: sync shared configurations [skip ci]

          ë™ê¸°í™”ëœ íŒŒì¼:
          $(echo "$CHANGED_FILES" | sed 's/^/- /')

          ğŸ”„ ìë™ ë™ê¸°í™” ì™„ë£Œ
          - ì‹œê°„: $(date)
          - ëŒ€ìƒ: ${{ matrix.team.repo }}

          âš ï¸ ì£¼ì˜ì‚¬í•­:
          1. yarn install ì‹¤í–‰ í•„ìš”
          2. ì¶©ëŒ ë°œìƒ ì‹œ ë‹´ë‹¹ìì—ê²Œ ë¬¸ì˜"

          git commit -m "$COMMIT_MSG"
          git push

      - name: Create sync report
        if: always()
        run: |
          echo "### ë™ê¸°í™” ê²°ê³¼ - ${{ matrix.team.name }} íŒ€" >> $GITHUB_STEP_SUMMARY
          echo "- ì €ì¥ì†Œ: ${{ matrix.team.repo }}" >> $GITHUB_STEP_SUMMARY
          echo "- ìƒíƒœ: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.check-changes.outputs.changes }}" == "true" ]]; then
            echo "- ë³€ê²½ì‚¬í•­: ìˆìŒ" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ë³€ê²½ì‚¬í•­: ì—†ìŒ" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ë™ê¸°í™” ì‹¤íŒ¨: ${{ matrix.team.repo }}`,
              body: `### ë™ê¸°í™” ì‹¤íŒ¨ ì•Œë¦¼
              - íŒ€: ${{ matrix.team.name }}
              - ì €ì¥ì†Œ: ${{ matrix.team.repo }}
              - ì›Œí¬í”Œë¡œìš°: ${context.workflow}
              - ì‹¤í–‰ ID: ${context.runId}

              ### ë¬¸ì œ í•´ê²° ë‹¨ê³„
              1. ì›Œí¬í”Œë¡œìš° ë¡œê·¸ í™•ì¸
              2. ì¶©ëŒ ì—¬ë¶€ í™•ì¸
              3. ìˆ˜ë™ ë™ê¸°í™” í•„ìš” ì—¬ë¶€ ê²€í† 

              cc: @team-leads`
            });
